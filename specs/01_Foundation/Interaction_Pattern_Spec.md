这份 **`02_Interaction_Pattern_Spec.md` v1.2 修正稿** 已根据造价业务的深度需求进行了全面强化。它不再仅仅是通用的 UI 规范，而是针对**高压力、高确定性**的造价工作场景设计的交互协议。

---

# 02_Interaction_Pattern_Spec.md (v1.2 - Final)

> **版本**: v1.2
> **状态**: Approved (Final)
> **最后更新**: 2026-01-17
> **核心原则**: 确保数据处理的确定性、操作的可追溯性及长流程任务的安全性。

---

## 一、 数据容器三态与局部加载 (Loading States)

### 1.1 全局三态 (State Triad)

**MUST**: 所有主数据视图（表格、列表、看板）必须支持以下三态：

* **Loading (骨架屏)**：根据布局选择 `TableSkeleton`, `TreeTableSkeleton` 或 `WorkbenchSkeleton`。动画采用 `shimmer` 效果。
* **Empty (空状态)**：区分“初始无数据”（引导创建）与“搜索无结果”（引导重置筛选）。
* **Error (错误态)**：提供错误代码及“重试”按钮。长表单提交失败时，**MUST** 提供“下载当前已录入数据”按钮以防数据丢失。

### 1.2 局部加载 (Partial Loading)

**MUST**: 在数据已存在的场景下（如：同步材价、重新计算单价），严禁刷掉整个页面进入骨架屏。

* **行级加载**: 在特定 Table Row 显示 Loading 占位符或置灰，允许用户继续操作其他行。
* **静默刷新**: 后台同步数据时，仅在页面右上角显示微型旋转图标，不阻塞用户交互。

---

## 二、 表单校验与保护 (Forms)

### 2.1 校验等级 (Validation Levels)

**MUST**: 区分以下两种校验反馈：

1. **硬约束 (Error)**:
* **判定**: 必填项缺失、格式错误。
* **后果**: 提交按钮禁用，显示红色错误提示。


2. **软约束/业务预警 (Warning)**:
* **判定**: 材价偏离基准区间 > 20%、含钢量超出历史分位线。
* **后果**: 显示橙色提示，**允许提交**，但在提交时弹出确认框：“检测到 N 项指标异常，是否确认提交？”。



### 2.2 自动保存与草稿 (Drafts)

* **触发**: 字段数  5 的表单开启 3 秒防抖自动保存至 `localStorage`。
* **UI 反馈**: **MUST** 在表单页脚或顶端显示微型文字：“*草稿已于 14:30:05 自动保存*”。
* **恢复**: 重新进入页面检测到草稿时，弹出提示：“检测到未保存的草稿，是否恢复？”。

### 2.3 离开保护

* **MUST**: 若表单处于 `isDirty`（已修改未保存）状态，用户点击导航或关闭窗口，必须弹出二次确认弹窗。

---

## 三、 弹窗与抽屉交互 (Modals & Drawers)

### 3.1 弹窗层级逻辑

| 组件 | 交互层级 | 遮罩规范 |
| --- | --- | --- |
| **Modal** | 强中断 | **MUST** 具有半透明遮罩（`rgba(0,0,0,0.45)`），禁止点击穿透。 |
| **Drawer** | 弱中断/对照编辑 | **MUST** 具有浅色遮罩（`rgba(0,0,0,0.1)`），且**必须允许**用户通过鼠标滚轮滚动背景的主内容区。 |

### 3.2 危险操作安全栓 (Safety Lock)

* **MUST**: 对于“清空数据”、“删除已发布资产”、“撤回审批”等不可逆操作，普通的确认按钮无效。
* **交互**: 必须在弹窗中手动输入“确认删除”或该项目的特定编号，方可激活“提交”按钮。

---

## 四、 反馈与提示 (Feedback)

### 4.1 Toast 提示

* **位置**: 全局顶部居中（Top Center）。
* **时长**: 成功/信息类 3 秒；错误类 5 秒或需手动关闭。

### 4.2 按钮反馈 (Button Feedback)

* **提交按钮**: 点击后立即进入 `Loading` 状态并禁用，文案变为“提交中...”，防止暴力点击。
* **批量操作**: 勾选列表后，批量操作栏浮动出现在列表底部或顶部，显示“已选中 N 项”。

---

## 五、 给 Windsurf 的执行指令 (Instruction)

1. **实现三态**: 所有数据表格必须封装 `DataView` 组件，处理骨架屏和重试逻辑。
2. **Drawer 特性**: 实现 Drawer 时，设置 `mask={true}` 但确保 `maskStyle={{ background: 'rgba(0,0,0,0.1)' }}` 且不拦截滚轮事件。
3. **校验逻辑**: 在表单逻辑中注入 `warning` 字段，用于处理“软约束”报警。
4. **安全栓**: 编写通用的 `SafetyConfirmModal` 组件，支持输入文本验证。

---

## 六、 变更记录 (Changelog)

* **v1.0**: 初始版本。
* **v1.1**: 增加自动草稿及 Toast 位置规范。
* **v1.2 (Final)**:
* 增加“行级局部加载”规范。
* 区分“硬性错误”与“业务预警”。
* 确定 Drawer 浅色遮罩及背景滚动逻辑。
* 增加危险操作的“安全栓”输入验证。



---

**下一步：**
请将此文件保存至 `specs/02_Interaction_Pattern_Spec.md`。
现在，我们已经完成了“骨架”和“动作”的规范。接下来，我们要讨论**核心细节** —— **`03_Data_Handling_Spec.md`**（数据展示与数字规范）。

在造价系统中，数字是核心。我们需要商定：

* **精度**: 单价、面积、合价分别保留几位小数？
* **单位**: 什么时候显示“元”，什么时候显示“万元”？
* **千分位**: 是否全局强制开启？
* **负数**: 红色显示还是括号显示？

**我们要开始讨论这些细节吗？**