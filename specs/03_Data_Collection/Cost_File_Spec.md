# 造价文件采集规范 (Cost File Spec)

> 版本：V1.0  
> 更新日期：2026-01-18  
> 所属模块：03_Data_Collection

---

## 1. 概述

### 1.1 功能定位

造价文件采集是数据采集模块的核心功能，负责：
- 汇集所有来源的造价文件（直接上传、质控模块、计价模块、估算模块）
- 提供文件预览、分析、补录、推送等全生命周期管理
- 解析出项目、材价、综价、指标数据，推送到"我的数据"

### 1.2 数据来源

| 来源 | 场景 | 采集方式 |
|------|------|----------|
| 直接上传 | 用户主动上传存量数据 | 完整采集 |
| 质控模块 | 做完检查后自动沉淀 | 快速采集（采集即用） |
| 计价模块 | 做完套定额后自动沉淀 | 快速采集（采集即用） |
| 估算模块 | 估算完成后自动沉淀 | 快速采集（采集即用） |

### 1.3 支持的文件格式

| 格式 | 来源软件 | 说明 |
|------|----------|------|
| .gbq | 广联达 | 广联达计价文件 |
| .gcfx | 宏业 | 宏业计价文件 |
| .cjz | 斯维尔 | 斯维尔计价文件 |
| .qtfx | 其他 | 清单计价文件 |
| .cos | 其他 | 造价文件 |
| .xml | 通用 | XML格式交换文件 |
| .xlsx | 通用 | Excel格式文件 |

---

## 2. 页面结构

### 2.1 造价文件列表页（主页面）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  数据采集 > 造价文件                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 操作栏 ────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  [+ 采集文件]     [批量删除]                    🔍 搜索项目名称      │   │
│  │                                                                      │   │
│  │  筛选：采集来源 [全部 ▼]  计价阶段 [全部 ▼]  地点 [全部 ▼]          │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 文件列表 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  □  项目名称          采集时间      采集来源    地点    计价阶段  操作│   │
│  │  ─────────────────────────────────────────────────────────────────── │   │
│  │  □  XX医院门诊楼项目   2026-01-18   直接上传   北京    招标控制价 ···│   │
│  │  □  XX学校教学楼工程   2026-01-17   质控模块   上海    结算      ···│   │
│  │  □  XX办公楼项目       2026-01-16   计价模块   广州    投标报价  ···│   │
│  │  □  XX住宅小区一期     2026-01-15   直接上传   深圳    招标控制价 ···│   │
│  │  □  XX商业综合体       2026-01-14   估算模块   杭州    概算      ···│   │
│  │                                                                      │   │
│  │  ─────────────────────────────────────────────────────────────────── │   │
│  │                                          共 128 条  < 1 2 3 ... 13 > │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 列表字段定义

| 字段 | 说明 | 宽度 | 排序 |
|------|------|------|------|
| 复选框 | 批量操作选择 | 40px | - |
| 项目名称 | 造价文件的项目名称 | 自适应 | 支持 |
| 采集时间 | 文件采集/上传时间 | 120px | 支持（默认降序） |
| 采集来源 | 直接上传/质控模块/计价模块/估算模块 | 100px | 支持 |
| 地点 | 项目所在地（省/市） | 100px | 支持 |
| 计价阶段 | 概算/预算/招标控制价/投标报价/结算 | 100px | 支持 |
| 操作 | 操作按钮组 | 200px | - |

### 2.3 操作按钮

| 按钮 | 图标 | 说明 | 触发弹窗 |
|------|------|------|----------|
| 查看 | 👁 | 预览造价文件结构和内容 | 查看弹窗（只读） |
| 分析 | ⚙️ | 标准化引擎分析处理 | 分析弹窗 |
| 补录 | ✏️ | 补充元数据信息 | 补录弹窗 |
| 推送 | 📤 | 推送到我的数据 | 推送确认弹窗 |
| 删除 | 🗑 | 删除文件 | 删除确认弹窗 |

**按钮状态规则：**

| 文件状态 | 查看 | 分析 | 补录 | 推送 | 删除 |
|----------|:----:|:----:|:----:|:----:|:----:|
| 待分析 | ✓ | ✓ | ✗ | ✗ | ✓ |
| 已分析 | ✓ | ✓ | ✓ | ✗ | ✓ |
| 已补录 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 已推送 | ✓ | ✗ | ✗ | ✗ | ✓ |

---

## 3. 采集文件弹窗

### 3.1 采集文件弹窗

点击 **[+ 采集文件]** 按钮，打开采集弹窗：

```
┌─────────────────────────────────────────────────────────────────┐
│  采集造价文件                                            [×]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │           📁                                            │   │
│  │                                                         │   │
│  │     将文件拖到此处，或 [点击选择文件]                    │   │
│  │                                                         │   │
│  │     支持格式：.gbq .gcfx .cjz .qtfx .cos .xml .xlsx    │   │
│  │     单个文件最大：500MB                                 │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─ 可选信息（可在补录时填写）─────────────────────────────┐   │
│  │                                                         │   │
│  │  地点：[请选择省份 ▼] [请选择城市 ▼]                    │   │
│  │                                                         │   │
│  │  计价阶段：[请选择 ▼]                                   │   │
│  │            ○ 概算  ○ 预算  ○ 招标控制价                 │   │
│  │            ○ 投标报价  ○ 结算                          │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─ 已选文件 ──────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  📄 XX医院项目.gbq              45.2 MB    [×]         │   │
│  │  📄 XX学校工程.gcfx             32.1 MB    [×]         │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                    [取消]    [开始采集]         │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 采集流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 选择文件  │ →  │ 上传文件  │ →  │ 解析文件  │ →  │ 入库完成  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                    │               │
                    ▼               ▼
               显示上传进度     显示解析进度
               (百分比+速度)   (解析中...)
```

**采集结果提示：**
- 成功：`采集成功！已添加 2 个造价文件到列表。`
- 部分失败：`采集完成！成功 1 个，失败 1 个。失败原因：文件格式不支持`
- 全部失败：`采集失败！原因：文件格式不支持`

---

## 4. 查看弹窗（预览）

### 4.1 查看弹窗界面

点击 **[查看]** 按钮，打开预览弹窗（只读模式）：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  查看造价文件 - XX医院门诊楼项目                                     [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 左侧：项目树 ─────────┐  ┌─ 右侧：单位工程详情 ────────────────────┐   │
│  │                        │  │                                          │   │
│  │  ☑ XX医院门诊楼项目    │  │  [分部分项] [措施项目] [其他项目]        │   │
│  │   ├─ ☑ 门诊楼          │  │  [规费]    [税金]                        │   │
│  │   │   ├─ ☑ 土建工程    │  │  ──────────────────────────────────────  │   │
│  │   │   ├─ ☑ 装饰工程    │  │                                          │   │
│  │   │   └─ □ 安装工程    │  │  当前显示：土建工程 - 分部分项            │   │
│  │   └─ □ 附属用房        │  │                                          │   │
│  │       ├─ □ 配电房      │  │  ┌──────────────────────────────────┐   │   │
│  │       └─ □ 水泵房      │  │  │ 序号│项目编码│项目名称│单位│工程量│   │   │
│  │                        │  │  │────│───────│───────│───│──────│   │   │
│  │  全选/取消 [☑]         │  │  │ 1  │010101 │土方开挖│m³ │ 2500 │   │   │
│  │                        │  │  │ 2  │010102 │土方回填│m³ │ 1800 │   │   │
│  │  已选: 3/6 个单位工程  │  │  │ 3  │010201 │混凝土  │m³ │ 3200 │   │   │
│  │                        │  │  │ ...│  ...  │  ...  │...│ ...  │   │   │
│  │                        │  │  │                                  │   │   │
│  │                        │  │  │          共 256 条               │   │   │
│  │                        │  │  └──────────────────────────────────┘   │   │
│  │                        │  │                                          │   │
│  └────────────────────────┘  └──────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  项目信息：建设单位：XX医院  |  地点：北京市  |  计价阶段：招标控制价        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                         [关闭]              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 左树结构

**三级树形结构：**

```
项目（根节点）
├─ 单项工程 1
│   ├─ 单位工程 1-1
│   ├─ 单位工程 1-2
│   └─ 单位工程 1-3
├─ 单项工程 2
│   ├─ 单位工程 2-1
│   └─ 单位工程 2-2
└─ ...
```

**树节点交互：**
- 支持多选（复选框）
- 点击节点：右侧联动显示该节点内容
- 勾选节点：用于后续分析/推送时选择范围
- 展开/折叠：点击箭头图标

### 4.3 右表结构

**Tab页签（以单位工程维度展示）：**

| Tab | 内容 | 列字段 |
|-----|------|--------|
| 分部分项 | 分部→分项→清单项/定额 | 序号、项目编码、项目名称、项目特征、单位、工程量、综合单价、合价 |
| 措施项目 | 措施费明细 | 序号、项目编码、项目名称、单位、工程量、单价、合价 |
| 其他项目 | 其他费用明细 | 序号、项目名称、金额、备注 |
| 规费 | 规费明细 | 序号、费用名称、计算基础、费率、金额 |
| 税金 | 税金明细 | 序号、税种、计算基础、税率、金额 |

**多选联动规则：**
- 左侧选择单个单位工程：右侧显示该单位工程的内容
- 左侧选择多个单位工程：右侧显示所有选中单位工程的合并内容
- 左侧选择单项工程：右侧显示该单项工程下所有单位工程的合并内容

---

## 5. 分析弹窗

### 5.1 分析弹窗界面

点击 **[分析]** 按钮，打开分析弹窗：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  分析造价文件 - XX医院门诊楼项目                                     [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 分析范围 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  ☑ 全部单位工程 (6个)                                               │   │
│  │                                                                      │   │
│  │  或选择部分：                                                        │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │  ☑ 门诊楼 - 土建工程                                           │ │   │
│  │  │  ☑ 门诊楼 - 装饰工程                                           │ │   │
│  │  │  ☑ 门诊楼 - 安装工程                                           │ │   │
│  │  │  □ 附属用房 - 配电房                                           │ │   │
│  │  │  □ 附属用房 - 水泵房                                           │ │   │
│  │  │  □ 附属用房 - 门卫室                                           │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 分析内容 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  ☑ 材料标准化（材料名称 → SMLCode + ParamMap）                      │   │
│  │  ☑ 清单标准化（清单项 → SBoQCode + FeatureMap）                     │   │
│  │  ☑ 指标计算（生成经济指标、工程量指标）                             │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                    [取消]    [开始分析]                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 分析进度

点击 **[开始分析]** 后显示进度：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  分析造价文件 - XX医院门诊楼项目                                     [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 分析进度 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  整体进度：████████████████████░░░░░░░░░░  67%                       │   │
│  │                                                                      │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │  ✓ 材料标准化        完成   1,256 条材料已标准化              │ │   │
│  │  │  ◐ 清单标准化        进行中 892/1,340 条清单已处理            │ │   │
│  │  │  ○ 指标计算          等待中                                   │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                      │   │
│  │  当前：正在处理清单标准化...                                         │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                              [取消分析]                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 分析结果

分析完成后显示结果：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  分析造价文件 - XX医院门诊楼项目                                     [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 分析结果 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  ✓ 分析完成                                                         │   │
│  │                                                                      │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │                                                                │ │   │
│  │  │  材料标准化：1,256 条                                          │ │   │
│  │  │    ├─ 自动匹配：1,180 条 (94%)                                 │ │   │
│  │  │    └─ 待人工确认：76 条 (6%)                                   │ │   │
│  │  │                                                                │ │   │
│  │  │  清单标准化：1,340 条                                          │ │   │
│  │  │    ├─ 自动匹配：1,285 条 (96%)                                 │ │   │
│  │  │    └─ 待人工确认：55 条 (4%)                                   │ │   │
│  │  │                                                                │ │   │
│  │  │  指标计算：已生成                                              │ │   │
│  │  │    ├─ 经济指标：单方造价 3,256 元/m²                           │ │   │
│  │  │    └─ 工程量指标：钢筋 58.6 kg/m²、混凝土 0.42 m³/m²          │ │   │
│  │  │                                                                │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           [查看详情]              [完成]                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 补录弹窗

### 6.1 补录弹窗界面

点击 **[补录]** 按钮，打开补录弹窗：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  补录元数据 - XX医院门诊楼项目                                       [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 基本信息 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  项目名称：XX医院门诊楼项目                      （来自文件，可修改）│   │
│  │                                                                      │   │
│  │  建设单位：[                                   ]                     │   │
│  │                                                                      │   │
│  │  设计单位：[                                   ]                     │   │
│  │                                                                      │   │
│  │  施工单位：[                                   ]                     │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 项目属性 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  地点：[北京市 ▼] [海淀区 ▼]                         *必填          │   │
│  │                                                                      │   │
│  │  计价阶段：[招标控制价 ▼]                            *必填          │   │
│  │            ○ 概算  ○ 预算  ○ 招标控制价  ○ 投标报价  ○ 结算        │   │
│  │                                                                      │   │
│  │  材价基准期：[2026 ▼] 年 [01 ▼] 月                   *必填          │   │
│  │                                                                      │   │
│  │  编制时间：[2026-01-15]                                              │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 建设规模 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  总建筑面积：[25000        ] m²    其中：地上 [20000] m²             │   │
│  │                                          地下 [5000 ] m²             │   │
│  │                                                                      │   │
│  │  总层数：地上 [12] 层  地下 [2] 层                                   │   │
│  │                                                                      │   │
│  │  结构类型：[框架结构 ▼]                                              │   │
│  │                                                                      │   │
│  │  功能标签：[综合医院 - 门诊楼 ▼]                     *必填          │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 造价信息（来自分析，可修改）───────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  工程总造价：[85,000,000    ] 元                                     │   │
│  │                                                                      │   │
│  │  单方造价：3,400 元/m²  （自动计算）                                 │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                    [取消]    [保存]                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 补录字段说明

| 分组 | 字段 | 必填 | 来源 | 说明 |
|------|------|:----:|------|------|
| 基本信息 | 项目名称 | 是 | 文件解析 | 可修改 |
| 基本信息 | 建设单位 | 否 | 手工填写 | - |
| 基本信息 | 设计单位 | 否 | 手工填写 | - |
| 基本信息 | 施工单位 | 否 | 手工填写 | - |
| 项目属性 | 地点 | 是 | 手工选择 | 省/市二级联动 |
| 项目属性 | 计价阶段 | 是 | 手工选择 | 枚举值 |
| 项目属性 | 材价基准期 | 是 | 手工选择 | 年/月 |
| 项目属性 | 编制时间 | 否 | 文件解析/手工 | 日期选择 |
| 建设规模 | 总建筑面积 | 否 | 文件解析/手工 | 数值 |
| 建设规模 | 地上/地下面积 | 否 | 手工填写 | 数值 |
| 建设规模 | 总层数 | 否 | 手工填写 | 数值 |
| 建设规模 | 结构类型 | 否 | 手工选择 | 枚举值 |
| 建设规模 | 功能标签 | 是 | 手工选择 | 标准库标签 |
| 造价信息 | 工程总造价 | 否 | 文件解析/手工 | 数值 |
| 造价信息 | 单方造价 | - | 自动计算 | 总造价/总面积 |

---

## 7. 推送弹窗

### 7.1 推送弹窗界面

点击 **[推送]** 按钮，打开推送确认弹窗：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  推送到我的数据 - XX医院门诊楼项目                                   [×]    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 推送内容预览 ──────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  将推送以下数据到"我的数据"：                                        │   │
│  │                                                                      │   │
│  │  ┌────────────────────────────────────────────────────────────────┐ │   │
│  │  │                                                                │ │   │
│  │  │  📁 我的项目                                                   │ │   │
│  │  │     └─ XX医院门诊楼项目（含 6 个单位工程）                     │ │   │
│  │  │                                                                │ │   │
│  │  │  📦 我的材价                                                   │ │   │
│  │  │     └─ 1,256 条材料价格数据                                    │ │   │
│  │  │                                                                │ │   │
│  │  │  📋 我的综价                                                   │ │   │
│  │  │     └─ 1,340 条清单综合单价数据                                │ │   │
│  │  │                                                                │ │   │
│  │  │  📊 我的指标                                                   │ │   │
│  │  │     └─ 6 条单位工程指标数据                                    │ │   │
│  │  │                                                                │ │   │
│  │  └────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 推送选项 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  ☑ 推送到我的项目                                                   │   │
│  │  ☑ 推送到我的材价（解析出的材料价格）                               │   │
│  │  ☑ 推送到我的综价（解析出的清单综价）                               │   │
│  │  ☑ 推送到我的指标（计算出的指标数据）                               │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ⚠️ 推送后，此文件状态将变为"已推送"，不可再次分析和补录。               │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                    [取消]    [确认推送]                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 推送结果

推送成功后提示：

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  ✓ 推送成功！                                           │
│                                                         │
│  已推送到：                                             │
│  • 我的项目：1 个项目                                   │
│  • 我的材价：1,256 条数据                               │
│  • 我的综价：1,340 条数据                               │
│  • 我的指标：6 条数据                                   │
│                                                         │
│  [去查看我的数据]                   [留在当前页面]       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 8. 推送数据映射规则

### 8.1 映射概述

推送操作将造价文件的原始数据转换并分发到"我的数据"的四个子模块：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   造价文件（原始结构）                         我的数据（目标结构）           │
│                                                                             │
│   ┌─────────────────────┐                    ┌─────────────────────┐       │
│   │                     │                    │                     │       │
│   │  项目信息            │ ────────────────▶ │  我的项目            │       │
│   │  ├─ 项目名称         │     映射规则1      │  ├─ 项目基本信息     │       │
│   │  ├─ 单位工程列表     │                    │  └─ 单位工程列表     │       │
│   │  └─ 补录元数据       │                    │                     │       │
│   │                     │                    └─────────────────────┘       │
│   │                     │                                                   │
│   │  工程量清单          │                    ┌─────────────────────┐       │
│   │  ├─ 分部分项         │ ────────────────▶ │  我的综价            │       │
│   │  ├─ 措施项目         │     映射规则2      │  ├─ 清单项目信息     │       │
│   │  └─ 其他项目         │                    │  └─ 综合单价组成     │       │
│   │                     │                    └─────────────────────┘       │
│   │                     │                                                   │
│   │  人材机汇总          │                    ┌─────────────────────┐       │
│   │  ├─ 人工小计         │ ────────────────▶ │  我的材价            │       │
│   │  ├─ 材料明细         │     映射规则3      │  ├─ 材料基本信息     │       │
│   │  └─ 机械明细         │                    │  └─ 价格信息        │       │
│   │                     │                    └─────────────────────┘       │
│   │                     │                                                   │
│   │  造价汇总            │                    ┌─────────────────────┐       │
│   │  ├─ 分部分项费       │ ────────────────▶ │  我的指标            │       │
│   │  ├─ 措施费          │     映射规则4      │  ├─ 经济指标         │       │
│   │  ├─ 其他费用         │    （计算生成）    │  ├─ 工程量指标       │       │
│   │  └─ 税金            │                    │  └─ 人材机指标       │       │
│   │                     │                    └─────────────────────┘       │
│   └─────────────────────┘                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 映射规则1：造价文件 → 我的项目

#### 8.2.1 项目级数据映射

| 源字段（造价文件） | 目标字段（我的项目） | 映射规则 |
|-------------------|---------------------|----------|
| project_name | project_name | 直接映射 |
| - | source_file_id | 关联造价文件ID |
| - | status | 固定值：pending（待标签化） |
| province（补录） | province | 直接映射 |
| city（补录） | city | 直接映射 |
| pricing_stage（补录） | pricing_stage | 直接映射 |
| price_base_date（补录） | price_base_date | 直接映射 |
| total_area（补录） | total_area | 直接映射 |
| total_cost（解析/补录） | total_cost | 直接映射 |
| function_tag_code（补录） | function_tag_code | 直接映射 |
| - | unit_cost | 计算：total_cost / total_area |

#### 8.2.2 单位工程数据映射

| 源字段（造价文件.单位工程） | 目标字段（my_project_unit） | 映射规则 |
|---------------------------|----------------------------|----------|
| unit_name | unit_name | 直接映射 |
| unit_type | profession_type | 映射：土建/装饰/安装/市政等 |
| area | building_area | 直接映射 |
| cost | total_cost | 直接映射 |
| - | unit_cost | 计算：cost / area |
| - | function_tag_code | 待标签化时匹配 |

#### 8.2.3 自动解析 vs 人工补录

| 字段 | 自动解析 | 人工补录 | 说明 |
|------|:--------:|:--------:|------|
| 项目名称 | ✓ | 可修改 | 从文件解析 |
| 单位工程列表 | ✓ | - | 从文件解析 |
| 工程总造价 | ✓ | 可修改 | 从文件解析 |
| 总建筑面积 | △ | ✓ | 部分格式可解析 |
| 地点 | ✗ | ✓ | 必须人工填写 |
| 计价阶段 | ✗ | ✓ | 必须人工填写 |
| 材价基准期 | △ | ✓ | 部分格式可解析 |
| 功能标签 | ✗ | ✓ | 必须人工选择 |

### 8.3 映射规则2：工程量清单 → 我的综价

#### 8.3.1 清单项目映射

| 源字段（造价文件.清单项） | 目标字段（my_composite_price） | 映射规则 |
|-------------------------|-------------------------------|----------|
| item_code | item_code | 直接映射 |
| item_name | item_name | 直接映射 |
| item_feature | item_feature | 直接映射 |
| unit | unit | 直接映射 |
| quantity | - | 不映射（仅价格数据） |
| composite_price | composite_price | 直接映射 |
| labor_cost | labor_cost | 直接映射 |
| material_cost | material_cost | 直接映射 |
| machine_cost | machine_cost | 直接映射 |
| management_cost | management_cost | 直接映射 |
| profit | profit | 直接映射 |
| - | source_type | 固定值：cost_file |
| - | source_file_id | 关联造价文件ID |
| - | source_project_id | 关联我的项目ID |
| - | province | 继承项目的地点 |
| - | price_date | 继承项目的材价基准期 |
| - | pricing_stage | 继承项目的计价阶段 |

#### 8.3.2 标准化处理

推送时自动调用标准化引擎：

```
清单项目名称 + 特征 ───▶ 标准化引擎 ───▶ SBoQCode + FeatureMap
```

| 标准化字段 | 说明 | 示例 |
|-----------|------|------|
| sboq_code | 标准清单编码 | SBQ0101 |
| sboq_name | 标准清单名称 | 现浇混凝土 |
| division_category | 分部分类路径 | 土建工程>混凝土工程>现浇混凝土 |
| match_status | 匹配状态 | matched/pending |
| match_confidence | 匹配置信度 | 92% |
| feature_map | 特征映射JSON | {"强度":"C30","方式":"泵送"} |

### 8.4 映射规则3：人材机汇总 → 我的材价

#### 8.4.1 材料数据映射

| 源字段（造价文件.材料） | 目标字段（my_material_price） | 映射规则 |
|------------------------|------------------------------|----------|
| material_name | material_name | 直接映射 |
| specification | specification | 直接映射 |
| unit | unit | 直接映射 |
| price | price | 直接映射（含税/不含税需标注） |
| - | source_type | 固定值：cost_file |
| - | source_file_id | 关联造价文件ID |
| - | source_project_id | 关联我的项目ID |
| - | province | 继承项目的地点 |
| - | price_date | 继承项目的材价基准期 |

#### 8.4.2 标准化处理

推送时自动调用标准化引擎：

```
材料名称 + 规格 ───▶ 标准化引擎 ───▶ SMLCode + ParamMap
```

| 标准化字段 | 说明 | 示例 |
|-----------|------|------|
| sml_code | 标准材料编码 | SML00123 |
| sml_name | 标准材料名称 | 热轧带肋钢筋 |
| material_category | 材料分类路径 | 金属材料>钢材>钢筋 |
| match_status | 匹配状态 | matched/pending |
| match_confidence | 匹配置信度 | 95% |
| param_map | 参数映射JSON | {"牌号":"HRB400","直径":"12mm"} |

#### 8.4.3 材料去重规则

同一造价文件可能包含多条相同材料，去重规则：

| 情况 | 处理方式 |
|------|----------|
| 完全相同（名称+规格+价格） | 合并为一条 |
| 名称规格相同，价格不同 | 保留多条，标记来源单位工程 |
| 名称相同，规格不同 | 保留多条 |

### 8.5 映射规则4：造价汇总 → 我的指标（计算生成）

#### 8.5.1 指标计算触发条件

指标不是直接映射，而是**计算生成**，触发条件：

| 条件 | 必要性 | 说明 |
|------|:------:|------|
| 已完成标签化 | 是 | 功能标签已分配 |
| 总建筑面积已填写 | 是 | 用于计算单位指标 |
| 工程总造价已确定 | 是 | 用于计算经济指标 |

#### 8.5.2 经济指标计算

| 指标 | 计算公式 | 单位 |
|------|----------|------|
| 单方造价 | 工程总造价 / 总建筑面积 | 元/m² |
| 土建占比 | 土建分部费 / 分部分项费 × 100% | % |
| 装饰占比 | 装饰分部费 / 分部分项费 × 100% | % |
| 安装占比 | 安装分部费 / 分部分项费 × 100% | % |
| 措施费占比 | 措施项目费 / 工程总造价 × 100% | % |

#### 8.5.3 工程量指标计算

| 指标 | 计算公式 | 单位 | 数据来源 |
|------|----------|------|----------|
| 钢筋含量 | 钢筋总量 / 总建筑面积 | kg/m² | 材料汇总 |
| 混凝土含量 | 混凝土总量 / 总建筑面积 | m³/m² | 材料汇总 |
| 模板含量 | 模板总量 / 总建筑面积 | m²/m² | 清单工程量 |
| 砌体含量 | 砌体总量 / 总建筑面积 | m³/m² | 清单工程量 |

#### 8.5.4 人材机指标计算

| 指标 | 计算公式 | 单位 |
|------|----------|------|
| 人工费占比 | 人工费合计 / 分部分项费 × 100% | % |
| 材料费占比 | 材料费合计 / 分部分项费 × 100% | % |
| 机械费占比 | 机械费合计 / 分部分项费 × 100% | % |

### 8.6 推送事务处理

#### 8.6.1 事务边界

推送操作作为一个**原子事务**，要么全部成功，要么全部回滚：

```
BEGIN TRANSACTION

1. 创建 my_project 记录
2. 创建 my_project_unit 记录（N条）
3. 创建 my_composite_price 记录（批量）
4. 创建 my_material_price 记录（批量）
5. 更新 cost_file.status = 'pushed'
6. 更新 cost_file.pushed_at = NOW()

COMMIT / ROLLBACK
```

#### 8.6.2 异常处理

| 异常情况 | 处理方式 |
|----------|----------|
| 标准化引擎超时 | 重试3次，失败则跳过标准化（match_status=pending） |
| 数据校验失败 | 回滚事务，返回错误详情 |
| 部分数据已存在 | 检查唯一性，跳过重复数据 |

### 8.7 推送后的数据状态

| 数据位置 | 推送前 | 推送后 |
|----------|--------|--------|
| 造价文件 | status=completed | status=pushed |
| 我的项目 | - | status=pending（待标签化） |
| 我的综价 | - | status=pending（待补录） |
| 我的材价 | - | status=pending（待补录） |
| 我的指标 | - | 待标签化完成后生成 |

---

## 9. 快速采集（自动沉淀）

### 9.1 快速采集流程

质控/计价/估算模块使用的简化采集流程：

```
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   质控/计价/估算模块                            数据采集模块              │
│                                                                          │
│   ┌────────────────┐                          ┌────────────────┐        │
│   │                │                          │                │        │
│   │  用户上传文件   │────── 自动沉淀 ─────────▶│  造价文件列表   │        │
│   │  采集即用      │                          │                │        │
│   │                │                          │  来源: 质控/   │        │
│   │  执行业务操作   │                          │  计价/估算     │        │
│   │  (检查/套定额)  │                          │                │        │
│   │                │                          │  状态: 待分析   │        │
│   │  业务完成      │                          │                │        │
│   │                │                          │                │        │
│   └────────────────┘                          └────────────────┘        │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 9.2 快速采集特点

| 特点 | 说明 |
|------|------|
| 采集即用 | 上传后直接进入业务操作，不需要填写任何信息 |
| 自动沉淀 | 业务完成后自动保存到造价文件列表 |
| 来源标识 | 自动标记来源为"质控模块"/"计价模块"/"估算模块" |
| 后续加工 | 用户可在数据采集模块继续分析、补录、推送 |

### 9.3 快速采集时的可选信息

在质控/计价模块上传文件时，可选填：
- 地点（省/市）
- 计价阶段

这些信息会随文件一起沉淀到造价文件列表，减少后续补录工作量。

---

## 10. 数据模型

### 10.1 造价文件表 (cost_file)

| 字段 | 类型 | 必填 | 说明 |
|------|------|:----:|------|
| id | VARCHAR(36) | 是 | 主键 |
| file_name | VARCHAR(200) | 是 | 原始文件名 |
| file_path | VARCHAR(500) | 是 | 存储路径 |
| file_size | BIGINT | 是 | 文件大小(字节) |
| file_format | VARCHAR(20) | 是 | 文件格式(gbq/gcfx等) |
| project_name | VARCHAR(200) | 是 | 项目名称 |
| source | VARCHAR(20) | 是 | 采集来源(upload/qc/pricing/estimation) |
| status | VARCHAR(20) | 是 | 状态(pending/analyzed/completed/pushed) |
| province | VARCHAR(50) | 否 | 省份 |
| city | VARCHAR(50) | 否 | 城市 |
| pricing_stage | VARCHAR(20) | 否 | 计价阶段 |
| price_base_date | DATE | 否 | 材价基准期 |
| total_area | DECIMAL(18,2) | 否 | 总建筑面积 |
| total_cost | DECIMAL(18,2) | 否 | 工程总造价 |
| function_tag_code | VARCHAR(50) | 否 | 功能标签编码 |
| created_at | TIMESTAMP | 是 | 采集时间 |
| created_by | VARCHAR(36) | 是 | 采集人 |
| analyzed_at | TIMESTAMP | 否 | 分析时间 |
| pushed_at | TIMESTAMP | 否 | 推送时间 |

### 10.2 状态枚举

| 状态 | 说明 | 可执行操作 |
|------|------|------------|
| pending | 待分析 | 查看、分析、删除 |
| analyzed | 已分析 | 查看、分析、补录、删除 |
| completed | 已补录 | 查看、分析、补录、推送、删除 |
| pushed | 已推送 | 查看、删除 |

---

## 11. 接口设计

### 11.1 接口列表

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取列表 | GET | /api/v1/cost-files | 分页查询造价文件列表 |
| 上传文件 | POST | /api/v1/cost-files/upload | 上传造价文件 |
| 获取详情 | GET | /api/v1/cost-files/{id} | 获取文件详情 |
| 获取预览 | GET | /api/v1/cost-files/{id}/preview | 获取文件预览数据(左树右表) |
| 执行分析 | POST | /api/v1/cost-files/{id}/analyze | 执行标准化分析 |
| 获取分析进度 | GET | /api/v1/cost-files/{id}/analyze/progress | 获取分析进度 |
| 补录元数据 | PUT | /api/v1/cost-files/{id}/metadata | 更新元数据 |
| 推送数据 | POST | /api/v1/cost-files/{id}/push | 推送到我的数据 |
| 删除文件 | DELETE | /api/v1/cost-files/{id} | 删除文件 |
| 批量删除 | DELETE | /api/v1/cost-files/batch | 批量删除文件 |

### 10.2 获取列表接口

**请求：**
```
GET /api/v1/cost-files?page=1&pageSize=20&source=upload&status=pending
```

**响应：**
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "cf-001",
        "fileName": "XX医院项目.gbq",
        "projectName": "XX医院门诊楼项目",
        "source": "upload",
        "sourceName": "直接上传",
        "status": "analyzed",
        "statusName": "已分析",
        "province": "北京市",
        "city": "海淀区",
        "pricingStage": "bidControl",
        "pricingStageName": "招标控制价",
        "createdAt": "2026-01-18T10:30:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 128,
      "totalPages": 7
    }
  }
}
```

### 10.3 获取预览接口

**请求：**
```
GET /api/v1/cost-files/{id}/preview
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "tree": [
      {
        "id": "proj-001",
        "name": "XX医院门诊楼项目",
        "type": "project",
        "children": [
          {
            "id": "item-001",
            "name": "门诊楼",
            "type": "itemProject",
            "children": [
              {
                "id": "unit-001",
                "name": "土建工程",
                "type": "unitProject"
              }
            ]
          }
        ]
      }
    ],
    "content": {
      "unitProjectId": "unit-001",
      "divisions": [...],
      "measures": [...],
      "others": [...],
      "fees": [...],
      "taxes": [...]
    }
  }
}
```

---

## 12. 版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2026-01-18 | 初版 | - |
| V1.1 | 2026-01-18 | 补充第8章"推送数据映射规则"，明确造价文件到我的数据的转换规则 | - |