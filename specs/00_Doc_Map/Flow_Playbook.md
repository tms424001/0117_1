# Flow Playbook（主线闭环作业手册）

> 版本：v0.9  
> 目的：任何人按本文“从0跑通”不需要额外口头解释

---

## A. Demo 前置条件
- 至少 1 份造价文件（支持解析树结构）
- 标准库已初始化：功能标签、规模分档、空间/专业映射字典

---

## B. 主线跑通（一步一页面）

### Step 1：采集导入（Collect）
- 入口：`/collect` → 【导入造价文件】
- 用户操作：
  1) 上传文件
  2) 系统解析 → 生成导入批次 batch
  3) 进入“原样预览页”
- 输出：
  - 数据湖对象（原始文件）
  - 解析树预览可见
- 失败处理：
  - 解析失败：显示日志+重试+下载错误报告

### Step 2：补录元数据（Processing/Metadata）
- 入口：导入批次详情 → 元数据卡片
- 用户操作：
  - 填：地区、省市、阶段、价格基准期、项目概况（最小）
- 输出：
  - batch 元数据完成（后续标签化/指标计算必须依赖）
- 阻断：
  - 缺省市/基准期：禁止进入“标签化完成/指标计算”

### Step 3：标签化工作台（Tagging）
- 入口：`/tagging/tasks` → 选择项目/批次 → 进入 workbench
- Stepper：
  1) 单体识别（确认单体边界/合并拆分）
  2) 功能标签（推荐+人工确认+可锁定）
  3) 面积/规模（总/地上/地下 + 功能规模；自动匹配规模档）
  4) 造价归集（空间×专业矩阵；低置信入待确认）
  5) 校验确认（阻断/警告清单；修正→完成）
- 输出：
  - 单体状态 completed
  - unit_cost_fact / unit_cost_detail 可用
- 失败处理：
  - 映射失败：落入QT/待确认
  - 面积不一致：阻断，必须修

### Step 4：指标计算（Index Calculation）
- 入口：`/indexes/calc/tasks` → 新建任务（全量/增量）
- 用户操作：
  1) 选目标基准期、异常方法、最小样本
  2) 运行 → 看进度
  3) 进入计算工作台查看某一组合（样本/异常/统计）
- 输出：
  - cost_index（draft）
  - index_sample（可追溯）
- 阻断：
  - 样本 < minSampleCount：不生成（标记 skipped）

### Step 5：审核发布（Index Publish）
- 入口：`/publish/versions`
- 用户操作：
  1) 创建版本（范围/基准期/规则口径固化）
  2) 提交审核（自动检查+人工抽查）
  3) 审核通过 → 发布（立即/定时/灰度）
- 输出：
  - IndexVersion=published
  - STR 生效指针指向该版本
- 关键承诺：
  - 已进行中的估算不受新版本影响（冻结）

### Step 6：指标匡算（Estimation Quick）
- 入口：`/estimation/tasks` → 新建任务 → 匡算页
- 用户操作：
  - 输入单体：功能标签、面积、规模档（可选）、地区
  - 选分位：P50 默认，可切 P25/P75
  - 计算 → 输出总价/单方/结构占比（简版）
- 输出：
  - EstimationSnapshot（可回放）
- 阻断：
  - 无可用指标（连L1都缺）：提示换标签或补样本

---

## C. 最小演示验收（必须全部通过）
- [ ] 导入一份造价文件并完成元数据
- [ ] 标签化一个单体并完成校验
- [ ] 指标计算生成至少 1 条指标
- [ ] 发布形成 1 个 published 版本
- [ ] 匡算调用该版本输出结果并生成快照

---

## Implementation Notes (Windsurf)

| 项目 | 待对齐 |
|------|--------|
| **路由文件** | `src/router/index.ts` |
| **组件路径** | — |
| **DTO** | — |
| **接口函数** | — |

> Windsurf 实现时在此补充实际路径与命名
