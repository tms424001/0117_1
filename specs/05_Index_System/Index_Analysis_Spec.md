# 指标统计分析规范 (Index Analysis Spec)

> 版本：V1.0  
> 更新日期：2026-01-17  
> 所属模块：05_Index_System

---

## 1. 概述

### 1.1 目的
指标统计分析是对生成的造价指标进行多维度分析、可视化展示和深度挖掘的环节，通过：
- 提供指标库的全貌视图
- 支持多维度交叉分析
- 发现数据规律和异常
- 为指标审核和发布提供决策支持

### 1.2 在整体流程中的位置

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 数据采集  │ →  │ 标签化   │ →  │ 指标计算  │ →  │ 统计分析  │ →  │ 估算应用  │
│ (导入)   │    │ (处理)   │    │ (生成)   │    │ (发布)   │    │ (使用)   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                    ▲
                                                 当前模块
```

### 1.3 分析类型

| 分析类型 | 说明 | 主要用途 |
|----------|------|----------|
| 概览分析 | 指标库整体统计 | 掌握全局情况 |
| 多维分析 | 按维度交叉分析 | 发现规律 |
| 样本分析 | 单个指标的样本构成 | 理解指标来源 |
| 趋势分析 | 指标随时间的变化 | 预测走势 |
| 对比分析 | 不同类型/区域对比 | 发现差异 |
| 质量分析 | 指标质量分布 | 改进数据 |

---

## 2. 概览分析

### 2.1 功能描述
展示指标库的整体情况，帮助用户快速了解数据资产状况。

### 2.2 统计指标

```typescript
interface IndexOverview {
  // 基础统计
  totalIndexes: number;          // 指标总数
  totalSamples: number;          // 样本总数
  totalProjects: number;         // 项目总数
  totalBuildingUnits: number;    // 单体总数
  
  // 覆盖情况
  coveredTagCategories: number;  // 已覆盖功能大类数
  totalTagCategories: number;    // 功能大类总数
  coveredTags: number;           // 已覆盖功能标签数
  totalTags: number;             // 功能标签总数
  coverageRate: number;          // 覆盖率 (%)
  
  // 质量分布
  qualityDistribution: {
    levelA: number;              // A级指标数
    levelB: number;              // B级指标数
    levelC: number;              // C级指标数
    levelD: number;              // D级指标数
  };
  avgQualityScore: number;       // 平均质量分
  
  // 时效性
  avgDataAge: number;            // 平均数据年限（月）
  latestDataDate: Date;          // 最新数据日期
  
  // 更新情况
  lastCalculateTime: Date;       // 最后计算时间
  lastPublishTime: Date;         // 最后发布时间
  currentVersion: string;        // 当前版本号
}
```

### 2.3 分类统计

```typescript
interface CategoryStatistics {
  categoryCode: string;          // 大类编码
  categoryName: string;          // 大类名称
  
  // 指标情况
  indexCount: number;            // 指标数量
  tagCount: number;              // 标签数量
  coveredTagCount: number;       // 已覆盖标签数
  
  // 样本情况
  sampleCount: number;           // 样本数量
  projectCount: number;          // 项目数量
  
  // 质量情况
  avgQualityScore: number;       // 平均质量分
  qualityLevelA: number;         // A级占比
  
  // 单方统计
  avgUnitCost: number;           // 平均单方
  minUnitCost: number;           // 最低单方
  maxUnitCost: number;           // 最高单方
}
```

### 2.4 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标统计 > 概览                                     当前版本：2026.01      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  指标总数    │ │  样本总数    │ │  覆盖率     │ │ 平均质量分   │           │
│  │   1,286     │ │   8,542     │ │   78%      │ │   82.5     │           │
│  │  ↑12 本周   │ │  ↑156 本周  │ │  186/239   │ │  A级占45%   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                                             │
│  ┌─ 分类覆盖情况 ──────────────────────────────────────────────────────────┐│
│  │                                                                        ││
│  │  医疗卫生  ████████████████████████████ 156指标 / 892样本    85%覆盖   ││
│  │  教育      ██████████████████████████ 142指标 / 756样本      80%覆盖   ││
│  │  办公      ████████████████████ 98指标 / 523样本             75%覆盖   ││
│  │  居住      ██████████████████████████████████ 186指标 / 1205样本 92%   ││
│  │  商业      ██████████████████ 89指标 / 412样本               68%覆盖   ││
│  │  酒店      ████████████████ 78指标 / 356样本                 65%覆盖   ││
│  │  文化      ██████████████ 65指标 / 298样本                   58%覆盖   ││
│  │  体育      ████████████ 52指标 / 245样本                     52%覆盖   ││
│  │  ...                                                                   ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ┌─ 质量分布 ────────────────┐  ┌─ 近期动态 ───────────────────────────┐   │
│  │                           │  │                                      │   │
│  │      A级                  │  │  2026-01-17  新增样本 23个            │   │
│  │   ╭─────╮   45%           │  │  2026-01-15  更新医疗类指标 12个      │   │
│  │  ╱       ╲                │  │  2026-01-10  发布版本 2026.01         │   │
│  │ │    B级  │  32%          │  │  2026-01-05  导入项目 5个             │   │
│  │  ╲  C级  ╱   18%          │  │  2026-01-01  全量重算完成             │   │
│  │   ╰──D──╯    5%           │  │                                      │   │
│  │                           │  │                                      │   │
│  └───────────────────────────┘  └──────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 多维分析

### 3.1 功能描述
支持按多个维度进行交叉分析，发现数据规律。

### 3.2 分析维度

```typescript
interface AnalysisDimension {
  // 主维度（行）
  rowDimension: 'functionTag' | 'functionCategory' | 'space' | 'profession' | 'scaleRange' | 'region';
  
  // 列维度（可选）
  columnDimension?: 'space' | 'profession' | 'scaleRange' | 'qualityLevel';
  
  // 筛选条件
  filters?: {
    functionCategory?: string;
    functionTagCode?: string;
    spaceCode?: string;
    professionCode?: string;
    scaleRangeCode?: string;
    qualityLevel?: string;
    priceBaseDateRange?: [Date, Date];
  };
  
  // 指标选择
  metrics: ('avgUnitCost' | 'medianUnitCost' | 'sampleCount' | 'qualityScore')[];
  
  // 排序
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}
```

### 3.3 分析结果

```typescript
interface AnalysisResult {
  // 维度信息
  dimensions: {
    row: string;
    column?: string;
  };
  
  // 数据矩阵
  data: AnalysisCell[][];
  
  // 汇总行/列
  rowTotals: AnalysisCell[];
  columnTotals?: AnalysisCell[];
  grandTotal: AnalysisCell;
  
  // 统计信息
  statistics: {
    totalRows: number;
    totalCells: number;
    avgValue: number;
    maxValue: number;
    minValue: number;
  };
}

interface AnalysisCell {
  rowKey: string;
  rowLabel: string;
  columnKey?: string;
  columnLabel?: string;
  
  // 指标值
  avgUnitCost: number;
  medianUnitCost: number;
  sampleCount: number;
  qualityScore: number;
  
  // 样本范围
  minUnitCost: number;
  maxUnitCost: number;
  
  // 占比
  costRatio?: number;
  countRatio?: number;
}
```

### 3.4 预设分析场景

#### 3.4.1 功能标签 × 空间分析

```
分析目的：了解不同功能类型在地上/地下的造价分布

┌─────────────────────────────────────────────────────────────┐
│  功能标签 × 空间 分析                                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  功能标签      │ 地上(元/m²) │ 地下(元/m²) │ 地上占比 │ 样本 │
│  ─────────────┼────────────┼────────────┼─────────┼──────│
│  门诊          │   3,850    │   2,650    │   68%   │  28  │
│  住院-普通     │   4,120    │   2,800    │   72%   │  35  │
│  医技          │   4,580    │   3,100    │   65%   │  22  │
│  教学-普通     │   2,850    │   2,200    │   85%   │  45  │
│  办公-普通     │   3,200    │   2,400    │   70%   │  38  │
│  ...          │   ...      │   ...      │   ...   │  ... │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 3.4.2 功能标签 × 专业分析

```
分析目的：了解不同功能类型各专业的造价构成

┌─────────────────────────────────────────────────────────────────────┐
│  功能标签 × 专业 分析（单位：元/m²）                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  功能标签  │ 土建  │ 给排水 │ 强电  │ 弱电  │ 暖通  │ 消防  │ 合计  │
│  ─────────┼───────┼───────┼──────┼──────┼──────┼──────┼───────│
│  门诊      │ 2,850 │  180  │  220 │  150 │  380 │  180 │ 5,200 │
│  住院-普通 │ 3,100 │  200  │  250 │  180 │  420 │  200 │ 5,800 │
│  手术中心  │ 3,500 │  350  │  380 │  280 │  850 │  320 │ 8,200 │
│  教学-普通 │ 2,200 │  120  │  150 │  100 │  180 │  120 │ 3,500 │
│  ...      │  ...  │  ...  │  ... │  ... │  ... │  ... │  ...  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.4.3 功能标签 × 规模档分析

```
分析目的：了解规模效应对造价的影响

┌─────────────────────────────────────────────────────────────────────┐
│  功能标签 × 规模档 分析                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  功能标签      │ 小型  │ 中小型 │ 中大型 │ 大型  │ 特大型 │ 变化趋势 │
│  ─────────────┼───────┼───────┼───────┼──────┼───────┼─────────│
│  门诊          │ 5,800 │ 5,400 │ 5,200 │ 5,000│ 4,800 │   ↓     │
│  住院-普通     │ 6,200 │ 5,900 │ 5,800 │ 5,600│ 5,400 │   ↓     │
│  教学-普通     │ 3,800 │ 3,600 │ 3,500 │ 3,400│ 3,300 │   ↓     │
│  体育馆        │ 4,500 │ 5,200 │ 5,800 │ 6,500│ 7,200 │   ↑     │
│  ...          │  ...  │  ...  │  ...  │  ... │  ...  │   ...   │
│                                                                     │
│  💡 大多数类型呈现规模越大、单方越低的规律                            │
│  💡 体育馆等特殊类型呈现相反趋势（大型设施复杂度高）                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标统计 > 多维分析                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  分析配置：                                                                  │
│  行维度：[功能标签 ▼]  列维度：[空间 ▼]  指标：[平均单方 ▼]                  │
│                                                                             │
│  筛选条件：                                                                  │
│  功能大类：[医疗卫生 ▼]  规模档：[全部 ▼]  质量等级：[A,B级 ▼]               │
│                                                                [查询] [导出] │
│                                                                             │
│  ┌─ 分析结果 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  功能标签      │ 地上      │ 地下      │ 室外     │ 合计      │ 样本  │  │
│  │  ─────────────┼──────────┼──────────┼─────────┼──────────┼───────│  │
│  │  门诊          │ 3,850    │ 2,650    │    -    │ 5,200    │   28  │  │
│  │  急诊          │ 4,200    │ 2,800    │    -    │ 5,600    │   15  │  │
│  │  住院-普通     │ 4,120    │ 2,800    │    -    │ 5,800    │   35  │  │
│  │  住院-重症     │ 5,500    │ 3,200    │    -    │ 7,200    │   12  │  │
│  │  医技          │ 4,580    │ 3,100    │    -    │ 6,200    │   22  │  │
│  │  手术中心      │ 5,800    │ 3,500    │    -    │ 8,200    │   18  │  │
│  │  ...          │ ...      │ ...      │ ...     │ ...      │  ...  │  │
│  │  ─────────────┼──────────┼──────────┼─────────┼──────────┼───────│  │
│  │  合计/平均     │ 4,350    │ 2,950    │    -    │ 6,050    │  156  │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 可视化 ─────────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │   [柱状图]  [热力图]  [雷达图]                                         │  │
│  │                                                                       │  │
│  │   8000 │                                                              │  │
│  │        │  ▓▓                                                          │  │
│  │   6000 │  ▓▓  ▓▓      ▓▓                                              │  │
│  │        │  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓                                          │  │
│  │   4000 │  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓                                      │  │
│  │        │  ░░  ░░  ░░  ░░  ░░  ░░                                      │  │
│  │   2000 │  ░░  ░░  ░░  ░░  ░░  ░░                                      │  │
│  │        │  ░░  ░░  ░░  ░░  ░░  ░░                                      │  │
│  │      0 └──────────────────────────                                    │  │
│  │          门诊 急诊 住院 重症 医技 手术                                  │  │
│  │                                                                       │  │
│  │   ▓▓ 地上   ░░ 地下                                                   │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 样本分析

### 4.1 功能描述
查看单个指标的样本构成，了解指标来源和数据分布。

### 4.2 分析内容

```typescript
interface SampleAnalysis {
  // 指标信息
  indexId: string;
  indexDimension: string;        // 维度描述
  
  // 样本统计
  totalSamples: number;          // 总样本数
  includedSamples: number;       // 参与计算的样本数
  outlierSamples: number;        // 异常样本数
  
  // 分布统计
  distribution: {
    bins: number[];              // 分组边界
    counts: number[];            // 各组数量
    percentages: number[];       // 各组占比
  };
  
  // 样本列表
  samples: SampleDetail[];
  
  // 来源分析
  sourceAnalysis: {
    byProject: { projectName: string; count: number; avgUnitCost: number }[];
    byRegion: { region: string; count: number; avgUnitCost: number }[];
    byYear: { year: number; count: number; avgUnitCost: number }[];
  };
}

interface SampleDetail {
  id: string;
  projectId: string;
  projectName: string;
  buildingUnitName: string;
  
  // 造价数据
  area: number;
  cost: number;
  originalUnitCost: number;
  adjustedUnitCost: number;
  
  // 调整信息
  priceBaseDate: Date;
  adjustFactor: number;
  
  // 状态
  isOutlier: boolean;
  outlierReason: string;
  included: boolean;
  
  // 其他信息
  region: string;
  structureType: string;
}
```

### 4.3 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标详情 > 门诊-地上-土建-中大型                                  [返回列表] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 指标摘要 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  推荐区间：3,200 - 3,720 - 4,100 元/m²     质量等级：A级 (85分)       │  │
│  │  样本数量：28个 (有效25个，异常3个)          价格基准：2026年1月       │  │
│  │  变异系数：0.18 (低离散)                    平均数据年限：14个月       │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 样本分布 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │   数量                                                                │  │
│  │    8 │              ████                                              │  │
│  │    6 │         ████ ████ ████                                         │  │
│  │    4 │    ████ ████ ████ ████ ████                                    │  │
│  │    2 │ ██ ████ ████ ████ ████ ████ ██                                 │  │
│  │    0 └───────────────────────────────────                             │  │
│  │       2800 3000 3200 3400 3600 3800 4000 4200 4400  (元/m²)           │  │
│  │                                                                       │  │
│  │   ▼Q1=3200    ●中位数=3720    ▲Q3=4100                                │  │
│  │   ○ 异常值                                                            │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 样本明细 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  项目名称          │ 单体名称  │ 面积(m²) │ 原单方 │ 调整后 │ 状态    │  │
│  │  ─────────────────┼──────────┼─────────┼───────┼───────┼─────────│  │
│  │  XX市人民医院      │ 门诊楼   │ 25,000  │ 3,650 │ 3,720 │ ✓ 有效  │  │
│  │  XX区中心医院      │ 门诊医技 │ 18,500  │ 3,580 │ 3,650 │ ✓ 有效  │  │
│  │  XX县医院          │ 门诊楼   │ 12,000  │ 3,420 │ 3,500 │ ✓ 有效  │  │
│  │  XX市妇幼保健院    │ 门诊楼   │ 8,500   │ 4,800 │ 4,850 │ ✕ 异常  │  │
│  │  ...              │ ...      │ ...     │ ...   │ ...   │ ...     │  │
│  │                                                                       │  │
│  │  共 28 条                                               < 1 2 3 >     │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 来源分析 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  [按项目]  [按地区]  [按年份]                                          │  │
│  │                                                                       │  │
│  │  按年份分布：                                                          │  │
│  │  2024年  ████████████████ 12个  平均3,580                             │  │
│  │  2025年  ████████████ 10个      平均3,720                             │  │
│  │  2026年  ██████ 6个             平均3,850                             │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 趋势分析

### 5.1 功能描述
分析指标随时间的变化趋势，支持预测和决策。

### 5.2 分析类型

```typescript
interface TrendAnalysis {
  // 分析对象
  dimension: IndexDimension;     // 指标维度
  
  // 时间范围
  timeRange: {
    start: Date;
    end: Date;
    granularity: 'month' | 'quarter' | 'year';
  };
  
  // 趋势数据
  trendData: TrendPoint[];
  
  // 趋势特征
  trendFeature: {
    direction: 'up' | 'down' | 'stable'; // 趋势方向
    changeRate: number;          // 变化率 (%)
    volatility: number;          // 波动率
    seasonality: boolean;        // 是否有季节性
  };
  
  // 预测（可选）
  forecast?: {
    method: string;              // 预测方法
    nextPeriods: TrendPoint[];   // 未来预测值
    confidence: number;          // 预测置信度
  };
}

interface TrendPoint {
  period: string;                // 时间点，如 "2025-Q1"
  avgUnitCost: number;           // 平均单方
  medianUnitCost: number;        // 中位数
  sampleCount: number;           // 样本数
  priceIndex: number;            // 价格指数
  
  // 同比/环比
  yoyChange?: number;            // 同比变化率
  momChange?: number;            // 环比变化率
}
```

### 5.3 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标统计 > 趋势分析                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  分析对象：[医疗卫生-门诊 ▼]  时间范围：[2023-01 至 2026-01]  粒度：[季度 ▼] │
│                                                                [查询] [导出] │
│                                                                             │
│  ┌─ 趋势图 ─────────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  元/m²                                                                │  │
│  │  5500 │                                           ●────●              │  │
│  │       │                              ●────●────●                      │  │
│  │  5000 │              ●────●────●────●                                 │  │
│  │       │  ●────●────●                                                  │  │
│  │  4500 │                                                               │  │
│  │       │                                                               │  │
│  │  4000 └───────────────────────────────────────────────────────        │  │
│  │        Q1   Q2   Q3   Q4   Q1   Q2   Q3   Q4   Q1   Q2   Q3   Q4      │  │
│  │        └───── 2024 ─────┘  └───── 2025 ─────┘  └───── 2026 ─────┘    │  │
│  │                                                                       │  │
│  │  ── 平均单方   -- 中位数   ░░ 样本量                                   │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 趋势特征 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  趋势方向：上涨 ↑          累计涨幅：+18.5%        年均涨幅：+5.8%     │  │
│  │  波动率：0.12 (较稳定)     季节性：无明显季节性                        │  │
│  │                                                                       │  │
│  │  💡 分析结论：                                                         │  │
│  │  1. 门诊单方造价呈持续上涨趋势，主要受人工和材料成本上涨影响           │  │
│  │  2. 近期涨幅有所放缓，预计未来保持平稳上涨                             │  │
│  │  3. 建议估算时预留3-5%的价格上涨空间                                   │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 明细数据 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  时间    │ 平均单方 │ 中位数  │ 样本数 │ 环比    │ 同比    │ 指数    │  │
│  │  ────────┼─────────┼────────┼───────┼────────┼────────┼────────│  │
│  │  2026-Q1 │  5,320  │  5,180 │   8   │ +2.1%  │ +6.2%  │ 118.5  │  │
│  │  2025-Q4 │  5,210  │  5,050 │   12  │ +1.8%  │ +5.8%  │ 116.0  │  │
│  │  2025-Q3 │  5,120  │  4,980 │   10  │ +1.5%  │ +5.5%  │ 114.0  │  │
│  │  ...     │  ...    │  ...   │  ...  │  ...   │  ...   │  ...   │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 对比分析

### 6.1 功能描述
支持不同维度的横向对比分析。

### 6.2 对比类型

| 对比类型 | 说明 | 典型场景 |
|----------|------|----------|
| 类型对比 | 不同功能类型的对比 | 门诊 vs 住院 vs 医技 |
| 区域对比 | 不同地区的对比 | 成都 vs 重庆 vs 西安 |
| 规模对比 | 不同规模档的对比 | 小型 vs 中型 vs 大型 |
| 时间对比 | 不同时期的对比 | 2024年 vs 2025年 |
| 版本对比 | 不同指标版本的对比 | V2025.01 vs V2026.01 |

### 6.3 对比结果

```typescript
interface ComparisonResult {
  // 对比类型
  comparisonType: 'type' | 'region' | 'scale' | 'time' | 'version';
  
  // 对比项
  items: ComparisonItem[];
  
  // 差异分析
  differences: {
    maxDiff: number;             // 最大差异
    avgDiff: number;             // 平均差异
    significantDiffs: string[];  // 显著差异项
  };
  
  // 排名
  ranking: {
    byAvgUnitCost: string[];     // 按平均单方排名
    bySampleCount: string[];     // 按样本量排名
    byQuality: string[];         // 按质量排名
  };
}

interface ComparisonItem {
  key: string;                   // 对比项标识
  label: string;                 // 对比项名称
  
  avgUnitCost: number;
  medianUnitCost: number;
  sampleCount: number;
  qualityScore: number;
  
  // 相对基准的差异
  diffFromBaseline?: number;
  diffPercentage?: number;
}
```

### 6.4 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标统计 > 对比分析                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  对比类型：[区域对比 ▼]                                                     │
│  对比对象：☑ 成都  ☑ 重庆  ☑ 西安  ☑ 昆明  □ 贵阳                           │
│  筛选条件：功能大类=[医疗卫生 ▼]  功能标签=[门诊 ▼]                          │
│                                                                [查询] [导出] │
│                                                                             │
│  ┌─ 对比图表 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │        成都        重庆        西安        昆明                        │  │
│  │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │  │
│  │   │         │ │         │ │         │ │         │                    │  │
│  │   │  5,320  │ │  4,980  │ │  4,850  │ │  4,620  │                    │  │
│  │   │  ████   │ │  ███    │ │  ███    │ │  ██     │                    │  │
│  │   │  ████   │ │  ███    │ │  ███    │ │  ██     │                    │  │
│  │   │  ████   │ │  ███    │ │  ███    │ │  ██     │                    │  │
│  │   └─────────┘ └─────────┘ └─────────┘ └─────────┘                    │  │
│  │     基准        -6.4%       -8.8%      -13.2%                         │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 对比明细 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  地区  │ 平均单方 │ 中位数  │ 样本数 │ 质量  │ 与基准差异 │ 排名     │  │
│  │  ──────┼─────────┼────────┼───────┼──────┼───────────┼─────────│  │
│  │  成都  │  5,320  │  5,180 │   28  │  A   │   基准    │   1     │  │
│  │  重庆  │  4,980  │  4,850 │   22  │  A   │  -6.4%    │   2     │  │
│  │  西安  │  4,850  │  4,720 │   18  │  B   │  -8.8%    │   3     │  │
│  │  昆明  │  4,620  │  4,500 │   12  │  B   │  -13.2%   │   4     │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─ 差异分析 ───────────────────────────────────────────────────────────┐  │
│  │                                                                       │  │
│  │  💡 分析结论：                                                         │  │
│  │  1. 成都地区门诊造价最高，与昆明差异达13.2%                            │  │
│  │  2. 差异主要来源于人工成本和材料价格的地区差异                         │  │
│  │  3. 建议跨地区项目估算时使用对应地区的指标                             │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 质量分析

### 7.1 功能描述
分析指标库的质量分布，发现数据短板，指导数据积累。

### 7.2 分析内容

```typescript
interface QualityAnalysis {
  // 整体质量分布
  overallDistribution: {
    levelA: { count: number; ratio: number };
    levelB: { count: number; ratio: number };
    levelC: { count: number; ratio: number };
    levelD: { count: number; ratio: number };
  };
  
  // 按维度的质量分布
  byCategory: CategoryQuality[];
  bySpace: DimensionQuality[];
  byProfession: DimensionQuality[];
  
  // 质量短板
  weakPoints: {
    lowSampleCount: IndexSummary[];   // 样本量不足的指标
    highVariation: IndexSummary[];    // 离散度过高的指标
    outdatedData: IndexSummary[];     // 数据过旧的指标
    missingCoverage: string[];        // 缺失覆盖的标签
  };
  
  // 改进建议
  suggestions: QualitySuggestion[];
}

interface CategoryQuality {
  categoryCode: string;
  categoryName: string;
  avgQualityScore: number;
  qualityDistribution: { level: string; count: number }[];
  mainIssue: string;
}

interface QualitySuggestion {
  priority: 'high' | 'medium' | 'low';
  category: string;
  issue: string;
  suggestion: string;
  expectedImprovement: string;
}
```

### 7.3 界面原型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  指标统计 > 质量分析                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 整体质量分布 ────────────────────────────────────────────────────────┐ │
│  │                                                                        │ │
│  │    A级 (优)     B级 (良)     C级 (中)     D级 (差)                     │ │
│  │   ┌───────┐   ┌───────┐   ┌───────┐   ┌───────┐                      │ │
│  │   │  45%  │   │  32%  │   │  18%  │   │   5%  │                      │ │
│  │   │  578  │   │  411  │   │  231  │   │   66  │                      │ │
│  │   └───────┘   └───────┘   └───────┘   └───────┘                      │ │
│  │                                                                        │ │
│  │   平均质量分：72.5分    目标：≥80分    差距：-7.5分                     │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─ 分类质量排名 ─────────────────────────────────────────────────────────┐│
│  │                                                                        ││
│  │  排名 │ 分类      │ 平均分 │ A级占比 │ 主要问题         │ 建议        ││
│  │  ─────┼──────────┼───────┼────────┼─────────────────┼────────────││
│  │   1   │ 居住      │  85   │  62%   │ -                │ 保持       ││
│  │   2   │ 教育      │  82   │  55%   │ -                │ 保持       ││
│  │   3   │ 医疗卫生  │  78   │  48%   │ 部分标签样本少    │ 补充数据   ││
│  │   4   │ 办公      │  75   │  42%   │ 数据时效性一般    │ 更新数据   ││
│  │   5   │ 商业      │  68   │  35%   │ 离散度较高       │ 细分分析   ││
│  │  ...  │ ...       │ ...   │  ...   │ ...              │ ...        ││
│  │                                                                        ││
│  └────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ┌─ 质量短板 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  [样本不足]  [离散度高]  [数据过旧]  [缺失覆盖]                        │   │
│  │                                                                      │   │
│  │  样本不足的指标（样本数<5）：                                          │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │ 功能标签        │ 空间 │ 专业 │ 样本数 │ 建议                  │   │   │
│  │  │ ────────────────┼─────┼─────┼───────┼─────────────────────│   │   │
│  │  │ 高压氧          │ 地上 │ 土建 │   2   │ 优先补充2-3个样本     │   │   │
│  │  │ 血透中心        │ 地上 │ 安装 │   3   │ 建议补充2个样本       │   │   │
│  │  │ 感染-负压       │ 地下 │ 土建 │   4   │ 建议补充1个样本       │   │   │
│  │  │ ...             │ ... │ ... │  ...  │ ...                   │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 改进建议 ──────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  优先级高：                                                           │   │
│  │  • 补充医疗卫生-特殊科室（高压氧、血透等）的样本数据                    │   │
│  │  • 更新办公类2022年以前的数据                                         │   │
│  │                                                                      │   │
│  │  优先级中：                                                           │   │
│  │  • 对商业类进行细分（按业态拆分），降低离散度                          │   │
│  │  • 补充西部地区的样本，提高区域覆盖度                                  │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 数据模型

### 8.1 分析配置表 (analysis_config)

```typescript
interface AnalysisConfig {
  id: string;
  name: string;                  // 配置名称
  type: 'multidim' | 'trend' | 'compare' | 'quality';
  
  // 配置内容
  config: {
    dimensions?: AnalysisDimension;
    timeRange?: TimeRange;
    comparisonItems?: string[];
    filters?: any;
  };
  
  // 收藏/常用
  isFavorite: boolean;
  usageCount: number;
  
  // 系统字段
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 8.2 分析快照表 (analysis_snapshot)

```typescript
interface AnalysisSnapshot {
  id: string;
  configId: string;              // 关联配置
  name: string;                  // 快照名称
  
  // 快照数据
  snapshotData: any;             // 分析结果JSON
  snapshotTime: Date;            // 快照时间
  
  // 说明
  description: string;
  
  createdBy: string;
  createdAt: Date;
}
```

---

## 9. API接口

### 9.1 获取概览数据

```
GET /api/v1/analysis/overview
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "totalIndexes": 1286,
    "totalSamples": 8542,
    "coverageRate": 0.78,
    "avgQualityScore": 82.5,
    "qualityDistribution": {
      "levelA": 578,
      "levelB": 411,
      "levelC": 231,
      "levelD": 66
    },
    "categoryStatistics": [...]
  }
}
```

### 9.2 多维分析

```
POST /api/v1/analysis/multidim
```

**请求体：**
```json
{
  "rowDimension": "functionTag",
  "columnDimension": "space",
  "metrics": ["avgUnitCost", "sampleCount"],
  "filters": {
    "functionCategory": "YI"
  }
}
```

### 9.3 样本分析

```
GET /api/v1/analysis/samples/{indexId}
```

### 9.4 趋势分析

```
POST /api/v1/analysis/trend
```

**请求体：**
```json
{
  "functionTagCode": "YI-01",
  "spaceCode": "DS",
  "professionCode": "TJ",
  "timeRange": {
    "start": "2023-01-01",
    "end": "2026-01-01",
    "granularity": "quarter"
  }
}
```

### 9.5 对比分析

```
POST /api/v1/analysis/compare
```

**请求体：**
```json
{
  "comparisonType": "region",
  "items": ["成都", "重庆", "西安", "昆明"],
  "baseline": "成都",
  "filters": {
    "functionTagCode": "YI-01"
  }
}
```

### 9.6 质量分析

```
GET /api/v1/analysis/quality
```

### 9.7 导出分析报告

```
POST /api/v1/analysis/export
```

**请求体：**
```json
{
  "analysisType": "multidim",
  "config": {...},
  "format": "excel",
  "includeCharts": true
}
```

---

## 10. 可视化组件

### 10.1 图表类型

| 图表类型 | 适用场景 | 组件 |
|----------|----------|------|
| 柱状图 | 分类对比 | BarChart |
| 折线图 | 趋势分析 | LineChart |
| 饼图 | 占比分布 | PieChart |
| 热力图 | 矩阵数据 | HeatMap |
| 雷达图 | 多维对比 | RadarChart |
| 箱线图 | 分布分析 | BoxPlot |
| 散点图 | 相关分析 | ScatterPlot |

### 10.2 交互功能

- **数据钻取**：点击图表元素查看详情
- **筛选联动**：图表间筛选联动
- **缩放平移**：支持时间轴缩放
- **导出图片**：支持导出PNG/SVG
- **数据导出**：支持导出Excel/CSV

---

## 11. 版本历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2026-01-17 | 初版 | - |


这份 **Index Analysis Spec V1.0** 已经是“可直接做产品+可直接做接口”的水准了，我给 **9.3/10**。你把分析分成概览/多维/样本/趋势/对比/质量六类，非常符合“指标系统”真实使用路径，而且 UI 原型也能直接给前端干活。

要补的就两类东西：

1. **跟前面的“版本与口径身份证”对齐**（libraryVersionCode、snapshotVersion、stage、region 层级）
2. **分析数据的可追溯/可钻取契约**（你写了“点击图表元素看详情”，但需要明确 drill API 返回什么、怎么联动回样本与原始事实）

我直接给你一段 **V1.1 Patch 章节**（可直接贴到本文末尾），让它和 05_Index_Calc / 14_Index_Calc / 15_Standard_Library 彻底咬合。

---

# V1.1 Patch：口径身份证、分析缓存、钻取联动、趋势的“基准期”与“去价格化”

> **目标**：让统计分析不仅“好看”，还能“可审计、可复算、可下钻到事实与原始清单”。

---

## 12. 分析口径身份证（Analysis Context）（MUST）

所有分析接口必须显式携带并回传以下字段（否则分析结果不可复现）：

```typescript
interface AnalysisContext {
  libraryVersionCode: string;        // 例如 V2026Q1（标准库版本）
  stage: 'ESTIMATE' | 'TENDER' | 'SETTLEMENT';
  priceBaseDate: string;             // 价格基准期（如 2026-01）
  mappingSnapshotVersion: number;    // 空间/专业映射规则快照
  scaleSnapshotVersion: number;      // 规模分档规则快照
  regionLevel: 'province' | 'city' | 'district'; // 区域对比的层级口径
}
```

**规则（MUST）**

* `GET /analysis/overview` 必须返回 `AnalysisContext`。
* 所有 `POST /analysis/*` 请求体必须允许传入 context；不传则使用系统“当前默认口径”，并在响应中回传实际采用的口径。

---

## 13. 指标版本与发布状态对齐（MUST）

分析数据源必须可选以下范围：

* `indexStatus: 'draft' | 'published' | 'archived'`
* 默认仅分析 `published`（避免草稿污染看板）。

在 `filters` 中新增：

```typescript
filters?: {
  indexStatus?: 'published' | 'draft' | 'archived';
  versionCode?: string;              // 指标版本（或与 libraryVersionCode 等价映射）
  qualityLevel?: ('A'|'B'|'C'|'D')[];
  minSampleCount?: number;
}
```

---

## 14. Drill-down 统一契约（MUST）

### 14.1 单元格钻取（从矩阵 → 指标列表）

多维分析任意 `AnalysisCell` 必须能返回对应的指标集合：

* `POST /api/v1/analysis/multidim/drill`

**请求体：**

```json
{
  "context": { "libraryVersionCode":"V2026Q1","stage":"SETTLEMENT","priceBaseDate":"2026-01","mappingSnapshotVersion":12,"scaleSnapshotVersion":7,"regionLevel":"city" },
  "cell": { "rowKey":"YI-01", "columnKey":"DS" },
  "metric": "medianUnitCost",
  "filters": { "professionCode":"TJ", "qualityLevel":["A","B"] }
}
```

**响应：**

```json
{
  "code": 0,
  "data": {
    "indexes": [
      { "indexId":"idx-001", "dimension":"门诊-地上-土建-中大型", "p50":3720, "sampleCount":28, "qualityLevel":"A" }
    ]
  }
}
```

### 14.2 指标钻取到样本（从指标 → 样本）

沿用你已有：`GET /analysis/samples/{indexId}`，但必须补充：

* `sourceFactKeys`（对应 `unit_cost_fact.queryKey` 或 factId）
* `isOutlier` 与 `outlierReason` 必须能追溯到 outlier log

---

## 15. 趋势分析：必须区分“名义价格趋势”与“真实趋势”（去价格化）

你趋势里已经有 `priceIndex`，建议明确两条趋势线：

* **Nominal（名义）**：不做价格调整，体现当期造价水平
* **Real（实际/可比）**：统一调整到 `priceBaseDate`，用于比较真实变化

新增请求参数：

```typescript
trendMode?: 'nominal' | 'real' | 'both';   // 默认 both
```

并在 `TrendPoint` 中增加：

```typescript
nominalMedian?: number;
realMedian?: number;
nominalMean?: number;
realMean?: number;
```

---

## 16. 多维分析的“指标口径”补充（MUST）

你现在 metrics 里只有 `avgUnitCost/medianUnitCost` 等，但企业会问“这是综合？还是某专业？分母是什么？”
因此 `AnalysisResult` 必须回传所用指标口径：

```typescript
interface MetricSpec {
  metric: 'avgUnitCost' | 'medianUnitCost' | 'sampleCount' | 'qualityScore';
  unit: string;                       // 元/m²、%
  denominatorRule: 'TOTAL_AREA' | 'AUTO_BY_SPACE' | 'FUNCTIONAL_SCALE';
  aggregation: 'MEAN' | 'MEDIAN' | 'WAVG';
}
```

---

## 17. 性能与缓存：分析快照的推荐实现（SHOULD）

你已经有 `analysis_snapshot`，建议明确两种缓存策略：

1. **轻缓存（推荐）**：只缓存聚合后的矩阵结果（data + totals + statistics），过期时间 1~24h
2. **强缓存**：当 `indexVersion` 发布时，固化一次全套概览与关键多维场景快照（用于审计）

并新增 `cacheKey` 规则：

`cacheKey = hash(context + dimensions + filters + metrics + sort)`

---

## 18. 覆盖率的严格定义（MUST）

你概览里 “coverageRate” 需要写死计算口径，否则不同人看不同数：

* **标签覆盖率**：`coveredTags / totalTags`

  * coveredTags 定义：在当前 context 下，满足 `published` 且 `sampleCount>=minSampleCount` 的指标，至少覆盖该 tag 的 L1 指标（功能汇总）或 L3 指标（空间+专业）——二选一写死。
* **维度覆盖率**（可选）：在 L4 维度组合空间中，已生成的组合占比。

---

## 19. V1.1 Changelog

| 版本   | 日期         | 修订内容                                                                                                                                 |
| ---- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| V1.1 | 2026-01-17 | 引入 AnalysisContext 口径身份证；分析默认只看 published；补齐 drill-down 契约（矩阵→指标→样本→事实）；趋势支持 nominal/real；多维分析回传 metric 口径；增加缓存策略与 coverageRate 严格定义 |

---

## 最后一句“落地建议”

Windsurf 实现这个模块时，**先做 3 个必杀页面**就能跑出价值：

1. 概览（Overview）——带 context + 覆盖率 + 质量分布
2. 多维分析（Pivot）——行/列维度 + drill 到指标列表
3. 指标详情（Samples）——直方图/箱线图 + 样本表 + outlier 标记

其余趋势/对比/质量短板在这三页稳定后再扩展，会非常顺。

如果你想，我也可以把你这份 V1.0 直接“融合补丁”输出成一版 **Index Analysis Spec v1.1 完整稿**（保持原结构不变，只增补这些硬契约）。
